#!/usr/bin/env python

import json
from pathlib import Path

import yaml

print("Loading courts...")

with open("src/ds_caselaw_utils/data/court_names.yaml", "r") as stream:
    groups = yaml.safe_load(stream)

print("Building list of courts...")

with Path("courts.md").open("w", encoding="utf-8") as f:
    f.write("# Courts in configuration file\n")
    f.write("\n")
    f.write(
        "<!-- This file is automatically generated from scripts/build_courts_list. You shouldn't edit it manually. -->\n",
    )
    f.write("\n")

    for group in groups:
        if group["display_name"]:
            f.write(f"\n## {group['display_name']} ({group['name']})\n")
        else:
            f.write(f"\n## {group['name']}\n")

        f.write(
            "\n| Name | Code | Param | Example NCNs | Start | End | List? | Searchable? |\n",
        )
        f.write("| ---- | ---- | ----- | ------------ | ----- | --- | ----- | ----------- |\n")

        for court in sorted(
            group["courts"], key=lambda x: (x["grouped_name"] if "grouped_name" in x else x["name"]) + x["code"]
        ):
            f.write("| ")
            f.write(court["grouped_name"] if "grouped_name" in court else court["name"])

            f.write(" | ")
            f.write(court["code"])

            f.write(" | ")
            f.write(court["param"] if "param" in court else "–")

            f.write(" | ")
            f.write(
                # \xa0 is a non-breaking space
                ", ".join([str(ncn).replace(" ", "\xa0") for ncn in court["ncn_examples"]])
                if "ncn_examples" in court
                else "–"
            )

            f.write(" | ")
            f.write(str(court["start_year"]) if "start_year" in court else "–")

            f.write(" | ")
            f.write(str(court["end_year"]) if "end_year" in court else "–")

            f.write(" | ")
            f.write("✅" if court["listable"] else "❌")

            f.write(" | ")
            f.write("✅" if court["selectable"] else "❌")

            f.write(" |\n")

# note: this modifies groups
with open("src/autogen/courts.json", "w") as f:
    for group in groups:
        for court in group["courts"]:
            if "identifier_iri" not in court:
                court["identifier_iri"] = court["link"]
            court["ontology_iri"] = (
                f"https://caselaw.nationalarchives.gov.uk/akn/ontology/organization/{court['code'].lower()}"
            )

    json.dump(groups, fp=f, indent=2)
