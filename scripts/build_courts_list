#!/usr/bin/env python

import csv
import json
import sys
from pathlib import Path
from typing import TYPE_CHECKING

import yaml

if TYPE_CHECKING:
    sys.path.insert(0, str(Path(__file__).parent.parent / "src"))
    from ds_caselaw_utils.types.courts_schema_autogen import RawCourtRepository

COURTS_REPOSITORY_FILE = "src/ds_caselaw_utils/data/court_names.yaml"


class CourtDataLoader:
    @classmethod
    def load_courts(cls, filename: str) -> "RawCourtRepository":
        print("Loading courts...")

        with open(filename, "r") as stream:
            court_repository: "RawCourtRepository" = yaml.safe_load(stream)

        return court_repository


class CourtOutputBuilder:
    def __init__(self) -> None:
        self.court_repository: "RawCourtRepository" = CourtDataLoader.load_courts(COURTS_REPOSITORY_FILE)
        for group in self.court_repository:
            for court in group["courts"]:
                if "identifier_iri" not in court:
                    court["identifier_iri"] = court["link"]

    def write_markdown(self, destination: str) -> None:
        print("Writing courts information to MarkDown…")

        with Path(destination).open("w", encoding="utf-8") as f:
            f.write("# Courts in configuration file\n")
            f.write("\n")
            f.write(
                "<!-- This file is automatically generated from scripts/build_courts_list. You shouldn't edit it manually. -->\n",
            )
            f.write("\n")

            for group in self.court_repository:
                if group["display_name"]:
                    f.write(f"\n## {group['display_name']} ({group['name']})\n")
                else:
                    f.write(f"\n## {group['name']}\n")

                f.write(
                    "\n| Name | Code | Param | Example NCNs | Start | End | List? | Searchable? |\n",
                )
                f.write("| ---- | ---- | ----- | ------------ | ----- | --- | ----- | ----------- |\n")

                for court in sorted(
                    group["courts"], key=lambda x: (x["grouped_name"] if "grouped_name" in x else x["name"]) + x["code"]
                ):
                    f.write("| ")
                    f.write(court["grouped_name"] if "grouped_name" in court else court["name"])

                    f.write(" | ")
                    f.write(court["code"])

                    f.write(" | ")
                    f.write(court["param"] if "param" in court else "–")

                    f.write(" | ")
                    f.write(
                        # \xa0 is a non-breaking space
                        ", ".join([str(ncn).replace(" ", "\xa0") for ncn in court["ncn_examples"]])
                        if "ncn_examples" in court
                        else "–"
                    )

                    f.write(" | ")
                    f.write(str(court["start_year"]) if "start_year" in court else "–")

                    f.write(" | ")
                    f.write(str(court["end_year"]) if "end_year" in court else "–")

                    f.write(" | ")
                    f.write("✅" if court["listable"] else "❌")

                    f.write(" | ")
                    f.write("✅" if court["selectable"] else "❌")

                    f.write(" |\n")

    def write_json(self, destination: str) -> None:
        print("Writing courts information to JSON…")

        with open(destination, "w") as f:
            json.dump(self.court_repository, fp=f, indent=2)

    def write_csv(self, destination: str) -> None:
        print("Writing courts information to CSV…")

        with open(destination, "w", encoding="utf-8", newline="") as f:
            writer = csv.writer(f)
            # Write header
            writer.writerow(
                [
                    "group_name",
                    "group_display_name",
                    "is_tribunal",
                    "court_name",
                    "court_code",
                    "grouped_name",
                    "long_name",
                    "param",
                    "ncn_examples",
                    "start_year",
                    "end_year",
                    "link",
                ]
            )

            # Write data rows
            for group in self.court_repository:
                for court in group["courts"]:
                    writer.writerow(
                        [
                            group["name"],
                            group.get("display_name", ""),
                            group.get("is_tribunal", False),
                            court["name"],
                            court["code"],
                            court.get("grouped_name", ""),
                            court.get("long_name", ""),
                            court.get("param", ""),
                            ", ".join(court.get("ncn_examples", [])),
                            court.get("start_year", ""),
                            court.get("end_year", ""),
                            court.get("link", ""),
                        ]
                    )


if __name__ == "__main__":
    builder = CourtOutputBuilder()
    builder.write_markdown("courts.md")
    builder.write_json("src/autogen/courts.json")
    builder.write_csv("src/autogen/courts.csv")
